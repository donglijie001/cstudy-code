[toc]

# 第一章 tcp/ip协议族

## arp 协议工作原理
为了测试arp的工作原理，这里准备了两台服务器和一个路由器。
![2022-08-26-09-08-55.png](linux高性能服务器编程.assets/2022-08-26-09-08-55.png)
arp协议能实现网络层地址到物理地址的转换。

### arp 高速缓存的的查看和修改
arp维护一个高速缓存（这个缓存是经常变化的），包含经常访问或者最近访问的机器的ip地址到物理地址的映射。
查看使用：arp-a 命令
![2022-08-26-09-22-53.png](linux高性能服务器编程.assets/2022-08-26-09-22-53.png)
可以看到cloud113 的Mac地址，ip地址，网卡名。
![2022-08-27-11-53-08.png](linux高性能服务器编程.assets/2022-08-27-11-53-08.png)

### 使用tcpdump观察ARP通信过程
首先，我在cloud112上删除cloud113的缓存记录，但是我查看以后，立刻就有了，原因应该是我这台电脑上还运行着k8s的程序，会不停的发心跳信息，所以，即使我删除arp缓存以后，马上就会有了。
抓包命令：**sudo tcpdump -i enx00e04c3613d6 -ent '(dst 192.168.32.113 and src 192.168.32.112)' >> log.txt**
我把tcpdump抓包的日志输出到文件里，然后执行 arp 的删除命令：**sudo arp -d 192.168.32.113**
![2022-08-27-13-30-37.png](linux高性能服务器编程.assets/2022-08-27-13-30-37.png)
00:e0:4c:36:13:d6是cloud112的mac地址。第一条记录，请求的目的地址是ff:ff:ff:ff:ff:ff，这是广播地址，该局域网的所有机器都会收到并处理这样的帧。

arp请求帧实际上也是以太网帧。

#### 以太网帧格式

以太网帧的格式：历史上以太网帧的格式有很多种，目前的格式是IEEE802.3格式。
![2022-08-27-13-56-38.png](linux高性能服务器编程.assets/2022-08-27-13-56-38.png)
![2022-08-27-13-59-56.png](linux高性能服务器编程.assets/2022-08-27-13-59-56.png)

> 以太网的类型：0x0800 表示帧的数据部分为IP数据报，以太网驱动程序会把帧交给IP模块，0x0806表示帧的数据部分为ARP请求或者应答报文。

#### 以太网ARP请求报文的格式

![image-20220827154534480](linux高性能服务器编程.assets/image-20220827154534480.png)

![image-20220827154720027](linux高性能服务器编程.assets/image-20220827154720027.png)

所以对于下面这个ARP请求报文，但是不知道为啥，我抓包的日志文件里，并没有arp请求的应答报文。书上说，只有目标主机才会响应arp请求。

```
00:e0:4c:36:13:d6 > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 42: Request who-has 192.168.32.113 tell 192.168.32.112, length 28
```

## DNS工作原理

dns报文格式

![image-20220827160554438](linux高性能服务器编程.assets/image-20220827160554438.png)

  16位标识字段用于标记一对DNS查询和应答，以此区分一个DNS应答是哪个DNS查询的应答。
  16位标志字段用于协商具体的通信方式和反馈通信状态。DNS报文头部的16位标志字段的细节如下表格所示：

![image-20220827160822280](linux高性能服务器编程.assets/image-20220827160822280.png)

QR，查询/应答标志。0表示这是一个查询报文，1表示这是一个应答报文。
    opcode，定义查询和应答的类型。0表示标准查询，1表示反向查询（通过IP地址获得主机域名），2表示请求服务器状态
    AA，授权应答标志。仅有应答报文使用。1表示域名服务器是授权服务器
    TC，截断标志。仅当DNS报文使用DNS服务时使用。因为UDP数据包有长度的限制，所以过长的DNS报文将被截断。1表示DNS报文超过512个字节，并被截断
    RD，递归查询标志。1表示执行递归查询，即如果目标DNS服务器无法解析某个主机名，则它将向其他DNS服务器继续查询，如此递归，直到获得结果，并把结果返回给客户端。0表示执行迭代查询，即如果目标DNS服务器无法解析某个主机名，则它将自己知道的其他DNS服务器的IP地址返回给客户端，以供客户端参考。
    RA，允许递归标志。仅由应答报文使用，1表示DNS服务器支持递归查询 
    zero，未使用位。设置位0
    rcode，4位返回码，表示应答的状态。常用值有0(无错误)，3(域名不存在)

[参考链接](https://blog.csdn.net/impossble_2017/article/details/117039914)

linux使用/etc/resolv.conf文件来存放dns服务器的ip地址。第一个是首选的dns服务器地址，第二个是备选的。

![image-20220827161407625](linux高性能服务器编程.assets/image-20220827161407625.png)

比如使用host命令查询百度这个域名的ip地址

![image-20220827161710111](linux高性能服务器编程.assets/image-20220827161710111.png)

使用tcpdump观察DNS通信过程

**sudo tcpdump -i enx00e04c3613d6 -nt -s 500 port domain**，然后我在另一个窗口输入：**host -t A www.baidu.com**，就可以看到tcpdump 抓到的报文了。

![image-20220827163112644](linux高性能服务器编程.assets/image-20220827163112644.png)

tcpdump 加上-X 会展示出报文的每一个字节。

![image-20220827163608295](linux高性能服务器编程.assets/image-20220827163608295.png)

[参考链接](https://blog.csdn.net/xiao666wang/article/details/107742372)